<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>Nurten ƒ∞la√ß Paneli</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ƒ∞la√ß Paneli">

<style>
/* --- A√áIK (LIGHT) MOD RENKLERƒ∞ --- */
:root {
  --bg: #F2F2F7; 
  --card: #FFFFFF; 
  --text: #1C1C1E; 
  --text-inverse: #FFFFFF;
  --muted: #8E8E93; 
  --line: rgba(0,0,0,0.06);
  --accent: #34C759; 
  --warning: #FF9500; 
  --danger: #FF3B30; 
  --early: #007AFF; 
  --purple: #AF52DE; 
  --shadow: 0 4px 12px rgba(0,0,0,0.05);
  --done-bg: rgba(52, 199, 89, 0.04);
  --done-border: rgba(52, 199, 89, 0.3);
  --advice-bg: rgba(0, 122, 255, 0.05);
  --advice-border: rgba(0, 122, 255, 0.15);
}

/* --- KARANLIK (DARK) MOD RENKLERƒ∞ --- */
@media (prefers-color-scheme: dark) {
  :root { 
    --bg: #0b0f17; 
    --card: #121a27; 
    --text: #eaf0ff; 
    --text-inverse: #000000;
    --muted: #a9b4cc; 
    --line: rgba(255,255,255,.08);
    --accent: #4ade80; 
    --warning: #fbbf24; 
    --danger: #ef4444; 
    --early: #60a5fa; 
    --purple: #c084fc;
    --shadow: 0 4px 15px rgba(0,0,0,0.4);
    --done-bg: rgba(74, 222, 128, 0.03);
    --done-border: rgba(74, 222, 128, 0.3);
    --advice-bg: rgba(96, 165, 250, 0.05);
    --advice-border: rgba(96, 165, 250, 0.15);
  }
}

* { box-sizing: border-box; }
body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; padding: 10px 10px 85px 10px; -webkit-font-smoothing: antialiased; overflow-x: hidden; transition: background 0.3s, color 0.3s; }

/* G√úVENLƒ∞K KALKANI (√ñZEL G√úN UYARILARI) */
#alertsArea { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
.safety-shield { display: none; padding: 10px; text-align: center; font-weight: 800; font-size: 13px; border-radius: 12px; box-shadow: var(--shadow); letter-spacing: 0.3px; color: white; }
.shield-red { background: linear-gradient(135deg, #ff3b30 0%, #c9342b 100%); animation: pulse-red 2s infinite; }
.shield-yellow { background: linear-gradient(135deg, #ff9500 0%, #d97706 100%); animation: pulse-yellow 2.5s infinite; }
.shield-purple { background: linear-gradient(135deg, #af52de 0%, #7e22ce 100%); animation: pulse-purple 2s infinite; }
.shield-blue { background: linear-gradient(135deg, #007aff 0%, #1d4ed8 100%); }

/* BA≈ûLIK */
.header-compact { text-align: center; margin-bottom: 10px; background: var(--card); padding: 10px; border-radius: 16px; border: 1px solid var(--line); box-shadow: var(--shadow); }
.app-title { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 4px; display: flex; justify-content: center; align-items: center; gap: 8px; }
.app-title span { font-size: 14px; font-weight: 700; color: var(--muted); }
.header-info { display: flex; justify-content: center; align-items: center; gap: 8px; }
.clock-text { font-size: 12px; font-weight: 700; color: var(--muted); }
.sync-badge { font-size: 11px; font-weight: 800; padding: 2px 8px; border-radius: 8px; background: var(--line); color: var(--text); }

/* Bƒ∞LE≈ûƒ∞K Bƒ∞LGƒ∞ KARTLARI (HAVA & ƒ∞LERLEME) */
.extra-card { background: var(--card); border-radius: 14px; padding: 12px; border: 1px solid var(--line); margin-bottom: 10px; box-shadow: var(--shadow); }
.extra-card details { margin-top: 0; border-top: none; padding-top: 0; }
.extra-card summary { cursor: pointer; list-style: none; outline: none; }
.extra-card summary::-webkit-details-marker { display: none; }

/* 3'L√ú HAVA DURUMU D√úZENƒ∞ */
.weather-summary { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.w-left { flex: 1; display: flex; justify-content: flex-start; align-items: center; gap: 4px; color: var(--early); font-weight: 800; font-size: 13px; white-space: nowrap; }
.w-center { flex: 1; display: flex; justify-content: center; }
.w-right { flex: 1; display: flex; justify-content: flex-end; }

.loc-badge { font-size: 10px; background: var(--line); padding: 4px 8px; border-radius: 6px; color: var(--muted); font-weight: 700; text-decoration: none; white-space: nowrap; max-width: 130px; overflow: hidden; text-overflow: ellipsis; display: inline-block; text-align: center;}
.show-text { font-size: 10px; color: var(--text); font-weight: 700; background: var(--line); padding: 4px 8px; border-radius: 6px; white-space: nowrap; display: flex; align-items: center; gap: 4px;}
.weather-advice { margin-top: 12px; padding: 12px; border-radius: 10px; background: var(--advice-bg); border: 1px solid var(--advice-border); font-size: 12px; color: var(--text); line-height: 1.5; font-weight: 600; display: flex; gap: 10px; align-items: flex-start; }
.adv-icon { font-size: 18px; }

/* ƒ∞LERLEME BARLARI */
.perf-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.perf-row:last-child { margin-bottom: 0; }
.perf-label { font-size: 12px; font-weight: 800; width: 95px; }
.bar-bg { flex: 1; background: var(--line); height: 8px; border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; transition: width 1s ease-in-out; }
.perf-val { font-size: 12px; font-weight: 800; font-family: ui-monospace, monospace; width: 45px; text-align: right; }

/* E≈ûƒ∞T BOYUTLU ƒ∞LA√á KARTLARI IZGARASI */
.cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: start; }
.card { 
  background: var(--card); border-radius: 16px; padding: 12px; border: 1px solid var(--line); 
  display: flex; flex-direction: column; box-shadow: var(--shadow);
  min-height: 135px; /* KARTLARIN E≈ûƒ∞T BOYDA DURMASINI SAƒûLAR */
  transition: all 0.3s ease; overflow: hidden;
}
.card.done-card { border-color: var(--done-border); background: var(--done-bg); }

/* OTOMATƒ∞K DARALMA MANTIƒûI */
.card.collapsed { min-height: 65px !important; max-height: 65px !important; cursor: pointer; }
.card.collapsed .meds-container { opacity: 0; pointer-events: none; }

.drug-name { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; margin-bottom: 6px; text-transform: uppercase; }
.badge { align-self: flex-start; padding: 4px 6px; border-radius: 6px; font-weight: 800; font-size: 9px; text-transform: uppercase; margin-bottom: 4px; }
.badge-safe { background: rgba(52, 199, 89, 0.15); color: var(--accent); }
.badge-wait { background: var(--line); color: var(--muted); }

.meds-container { margin-top: 4px; flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 4px; transition: opacity 0.3s; }
.history-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; border-bottom: 1px dashed var(--line); }
.history-item:last-child { border-bottom: none; }
.mono { font-size: 10px; color: var(--muted); font-weight: 600; font-style: italic;}

/* Mƒ∞Nƒ∞K BUTONU */
.minik-button { position: fixed; bottom: 20px; right: 20px; background: var(--card); width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--line); z-index: 1000; cursor: pointer; }
.minik-toast { position: fixed; bottom: 90px; right: 20px; background: var(--early); color: #fff; padding: 16px; border-radius: 16px; font-size: 13px; font-weight: 800; display: none; z-index: 1001; width: 220px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); line-height: 1.4; text-align: center; }

@keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
@keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
@keyframes pulse-purple { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
</style>
</head>
<body onclick="document.getElementById('minikToast').style.display = 'none'">

<div id="alertsArea"></div>

<div class="header-compact">
    <div class="app-title"><span id="greetingText">G√ºnaydƒ±n,</span> Nurten Sultan üåº</div>
    <div class="header-info">
        <div id="clock" class="clock-text">--:--</div>
        <div id="last-sync" class="sync-badge">üîÑ Baƒülanƒ±yor...</div>
    </div>
</div>

<div class="extra-card">
    <details>
        <summary class="weather-summary">
            <div class="w-left" id="wBrief">üå•Ô∏è --¬∞C | %--</div>
            <div class="w-center">
                <a href="https://share.google/XZEP3J5L3bhQtAij8" target="_blank" class="loc-badge">üìç Avrupark Hayat</a>
            </div>
            <div class="w-right">
                <div class="show-text">√ñneriler <span>‚ñº</span></div>
            </div>
        </summary>
        <div class="weather-advice">
            <span class="adv-icon" id="wAdvIcon">ü©∫</span>
            <span id="wAdvice">Hava durumu te≈ühisleri y√ºkleniyor...</span>
        </div>
    </details>
</div>

<div class="extra-card">
    <div class="perf-row">
        <div class="perf-label">G√ºnl√ºk ƒ∞lerleme</div>
        <div class="bar-bg"><div id="perf-bar" class="bar-fill" style="width: 0%; background-color: var(--accent);"></div></div>
        <div id="perf-pct" class="perf-val" style="color: var(--accent);">%0</div>
    </div>
    <div class="perf-row">
        <div class="perf-label">Aylƒ±k ƒ∞lerleme</div>
        <div class="bar-bg"><div id="month-bar" class="bar-fill" style="width: 45%; background-color: var(--early);"></div></div>
        <div id="month-pct" class="perf-val" style="color: var(--early);">%45</div>
    </div>
</div>

<div id="timelineArea" class="cards-grid">
    </div>

<div class="minik-button" onclick="event.stopPropagation(); mewMsg()">üêæ</div>
<div class="minik-toast" id="minikToast">Miyav! ‚ù§Ô∏è</div>

<script>
// KENDƒ∞ Lƒ∞NKƒ∞Nƒ∞ BURAYA YAPI≈ûTIRMAYI UNUTMA
const API_URL = "https://script.google.com/macros/s/AKfycbybibVR75b918CBOMRlpEJu699hHSvOvCFXD6qRAL-JUxmK95HIUcF5onhEQjrIbF67Wg/exec"; 
let sonBasariZamani = 0;
let fetchDevamEdiyor = false;
let apiData = {};

// GREETING
const now = new Date();
const hour = now.getHours();
let gMsg = (hour >= 5 && hour < 12) ? "G√ºnaydƒ±n" : (hour >= 12 && hour < 17) ? "T√ºnaydƒ±n" : (hour >= 17 && hour < 22) ? "ƒ∞yi Ak≈üamlar" : "ƒ∞yi Geceler";
document.getElementById('greetingText').innerText = `${gMsg},`;

// GELƒ∞≈ûMƒ∞≈û HAVA DURUMU & HASTALIK TE≈ûHƒ∞S MOTORU
async function fetchWeather() {
    try {
        // Avrupark Hayat Sitesi civarƒ± tam koordinatlar (Esenyurt/Ho≈üdere)
        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=41.07&longitude=28.64&current=temperature_2m,relative_humidity_2m');
        const data = await res.json();
        const t = data.current.temperature_2m, h = data.current.relative_humidity_2m;
        
        let icon = "üå•Ô∏è";
        let advIcon = "ü©∫";
        let adv = "Hava bug√ºn senin i√ßin gayet g√ºzel g√∂r√ºn√ºyor. Romatizma ve Sj√∂gren a√ßƒ±sƒ±ndan rahat bir g√ºn, fƒ±rsat bulursan biraz y√ºr√ºy√º≈ü yapabilirsin.";
        
        if (h > 70 && t < 15) { 
            icon = "üåßÔ∏è"; advIcon = "‚ö†Ô∏è";
            adv = `Hava soƒüuk ve nemli (%${h}). Romatizmal eklem aƒürƒ±larƒ±n artabilir; dizlerini sƒ±cak tutmaya ve kendini yormamaya √∂zen g√∂ster.`; 
        }
        else if (t < 12) { 
            icon = "ü•∂"; advIcon = "üß£";
            adv = `Dƒ±≈üarƒ±sƒ± olduk√ßa soƒüuk (${t}¬∞C). Eklemlerini mutlaka sƒ±cak tutmalƒ±sƒ±n. R√ºzgar varsa Sj√∂gren kaynaklƒ± g√∂z kuruluƒüuna kar≈üƒ± damlalarƒ±nƒ± yanƒ±na al.`; 
        }
        else if (h > 75) { 
            icon = "üå´Ô∏è"; advIcon = "üíß";
            adv = `Nem oranƒ± √ßok y√ºksek (%${h}). Bu durum romatizmanƒ± tetikleyebilir, bug√ºn fiziksel olarak kendini fazla zorlama.`; 
        }
        else if (t > 28) { 
            icon = "‚òÄÔ∏è"; advIcon = "üï∂Ô∏è";
            adv = `Hava olduk√ßa sƒ±cak. Sj√∂gren nedeniyle aƒüƒ±z ve g√∂z kuruluƒüun artabilir. Bol bol su i√ßmeyi ve g√∂z damlalarƒ±nƒ± sƒ±k kullanmayƒ± unutma.`; 
        }
        
        document.getElementById('wBrief').innerHTML = `${icon} ${t}¬∞C | %${h}`;
        document.getElementById('wAdvIcon').innerText = advIcon;
        document.getElementById('wAdvice').innerHTML = adv;
    } catch(e) { }
}
fetchWeather();

// Mƒ∞Nƒ∞K TOAST
function mewMsg() {
    const msgs = [
        "Nenesinin kuzusu, ila√ßlarƒ±nƒ± i√ßmen beni d√ºnyanƒ±n en mutlu kuzusu yapƒ±yor.",
        "G√∂ker'e s√∂yledim, sana bug√ºn her zamankinden daha iyi bakacak.",
        "Sen g√ºl√ºnce benim bƒ±yƒ±klarƒ±m titriyor sevin√ßten, hep g√ºl!",
        "Eklemlerin aƒürƒ±masƒ±n diye yanƒ±na kƒ±vrƒ±lƒ±p orayƒ± ƒ±sƒ±tacaƒüƒ±m.",
        "Cimzia g√ºn√º gelince sakƒ±n korkma, ben senin dizinin dibindeyim.",
        "Mamanƒ± yedin mi? Suyun taze mi? Nenesinin kuzusu takibindeyim!"
    ];
    const t = document.getElementById('minikToast');
    t.innerText = msgs[Math.floor(Math.random() * msgs.length)];
    t.style.display = 'block';
}

// SAAT VE SENKRONƒ∞ZASYON
function saniyeTiktak() {
    const syncElement = document.getElementById('last-sync');
    const clockElement = document.getElementById('clock');
    const simdi = Date.now();
    const dNow = new Date();
    
    clockElement.textContent = dNow.getDate() + " " + dNow.toLocaleDateString('tr-TR', {month:'short'}) + " ‚Ä¢ " + String(dNow.getHours()).padStart(2,'0') + ':' + String(dNow.getMinutes()).padStart(2,'0');

    const farkSaniye = sonBasariZamani > 0 ? Math.floor((simdi - sonBasariZamani) / 1000) : 999;
    
    if (sonBasariZamani === 0) {
        syncElement.innerHTML = `üîÑ Baƒülanƒ±yor...`; syncElement.style.color = "var(--warning)";
    } else if (farkSaniye < 20) {
        const d = new Date(sonBasariZamani);
        syncElement.innerHTML = `üü¢ Canlƒ± (${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')})`;
        syncElement.style.color = "var(--accent)";
    } else if (farkSaniye < 60) {
        syncElement.innerHTML = `üü° ${farkSaniye} sn √∂nce`; syncElement.style.color = "var(--warning)";
    } else {
        syncElement.innerHTML = `üî¥ Hata Yoklama`; syncElement.style.color = "var(--danger)";
    }
}

// PROGRAM HESAPLAYICI
function getDailyProgram(dateObj) {
    let day = dateObj.getDay(); let mid = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    let p = [
      { id: 'sabah-ac', title: 'SABAH A√á', time: '06:00', icon: 'üåÖ', meds: [{ key: 'SABAH_AC_INH', name: 'INH', purpose: 'Tbc' }] },
      { id: 'sabah-tok', title: 'SABAH TOK', time: '10:00', icon: 'üç≥', meds: [{ key: 'SABAH_TOK_BALIK', name: 'Balƒ±k Yaƒüƒ±', purpose: 'Destek' }, { key: 'SABAH_TOK_GOZ', name: 'G√∂z Damlasƒ±', purpose: 'Sj√∂gren' }] },
      { id: 'ogle', title: '√ñƒûLE', time: '13:00', icon: '‚òÄÔ∏è', meds: [{ key: 'OGLE_BENEXOL', name: 'Benexol', purpose: 'B12' }] },
      { id: 'aksam', title: 'AK≈ûAM', time: '18:00', icon: 'üåô', meds: [{ key: 'AKSAM_PLAQUENIL', name: 'Plaquenil', purpose: 'Romatizma' }] },
      { id: 'gece', title: 'GECE', time: '21:00', icon: 'üõå', meds: [{ key: 'GECE_QUANTAVIR', name: 'Quantavir', purpose: 'Hepatit' }, { key: 'GECE_GOZ', name: 'G√∂z Damlasƒ±', purpose: 'Sj√∂gren' }] }
    ];
    
    const dS = new Date(2026, 1, 16); 
    if(Math.round((mid - dS)/(1000*60*60*24)) % 2 === 0) p[1].meds.push({ key: 'SABAH_TOK_DELTA', name: 'Deltacortril', purpose: 'Kortizon' });
    if(day === 2) { p[1].meds.push({ key: 'SABAH_TOK_COLEDAN', name: 'Coledan-D3', purpose: 'Vit D' }); p[4].meds.push({ key: 'GECE_FOLBIOL', name: 'Folbiol', purpose: 'Folik' }); }
    if(day === 1) p[4].meds.push({ key: 'GECE_METOARTCON', name: 'Metoartcon', purpose: 'ƒ∞ƒüne' });
    const cS = new Date(2026, 1, 12);
    if(Math.round((mid - cS)/(1000*60*60*24)) % 14 === 0) p[4].meds.push({ key: 'GECE_CIMZIA', name: 'Cimzia ƒ∞ƒünesi', purpose: 'Biyolojik' });
    return p;
}

// VERƒ∞ √áEKME VE EKRAN √áƒ∞Zƒ∞Mƒ∞
async function veriCek() {
    if (fetchDevamEdiyor) return;
    fetchDevamEdiyor = true;
    
    const todayStr = String(now.getDate()).padStart(2, '0') + '.' + String(now.getMonth() + 1).padStart(2, '0') + '.' + now.getFullYear();
    try {
        const res = await fetch(`${API_URL}?tarih=${todayStr}`);
        if (!res.ok) throw new Error("Aƒü Hatasƒ±");
        apiData = await res.json();
        sonBasariZamani = Date.now();
        ekraniCiz();
    } catch(e) { console.error(e); } finally { fetchDevamEdiyor = false; }
}

function ekraniCiz() {
    const todayProg = getDailyProgram(now);
    
    // 1. √ñZEL G√úN KALKANLARI
    let alertsHTML = "";
    todayProg.forEach(s => {
        s.meds.forEach(m => {
            if(m.key === 'SABAH_TOK_DELTA') alertsHTML += `<div class="safety-shield shield-red" style="display:block;">üö® Bug√ºn Deltacortril G√ºn√º</div>`;
            if(m.key === 'SABAH_TOK_COLEDAN') if(!alertsHTML.includes('Vitamin')) alertsHTML += `<div class="safety-shield shield-yellow" style="display:block;">‚òÄÔ∏è Bug√ºn Vitamin ve Folbiol G√ºn√º</div>`;
            if(m.key === 'GECE_METOARTCON') alertsHTML += `<div class="safety-shield shield-blue" style="display:block;">üß¨ Bug√ºn Metoartcon ƒ∞ƒüne G√ºn√º</div>`;
            if(m.key === 'GECE_CIMZIA') alertsHTML += `<div class="safety-shield shield-purple" style="display:block;">üíâ Bug√ºn Cimzia ƒ∞ƒüne G√ºn√º! ≈ûifa olsun.</div>`;
        });
    });
    document.getElementById('alertsArea').innerHTML = alertsHTML;

    // 2. ƒ∞LA√á KARTLARI (E≈ûƒ∞T BOYUTLU VE DARALAN)
    let tArea = "";
    let tMT = 0, tKT = 0;

    todayProg.forEach(s => {
        let sTC = 0; 
        let medsHTML = "";
        
        s.meds.forEach(m => { 
            tMT++; 
            const isDone = apiData[m.key] === "ƒ∞√ßildi";
            if(isDone) { tKT++; sTC++; }
            
            const icon = isDone ? `<span style="color:var(--accent); font-size:15px;">‚úÖ</span>` : `<span style="font-size:15px;">‚ö™</span>`;
            medsHTML += `
                <div class="history-item">
                    <span style="display:flex; align-items:center; gap:6px; font-weight:700;">${icon} ${m.name}</span>
                    <span class="mono">${m.purpose}</span>
                </div>`; 
        });
        
        const isAllDone = (sTC === s.meds.length);
        const badgeClass = isAllDone ? "badge-safe" : "badge-wait";
        const badgeText = isAllDone ? "TAMAMLANDI ‚ñº" : "BEKLƒ∞YOR";
        
        const cardClass = isAllDone ? "done-card collapsed" : "";
        const onClick = isAllDone ? `onclick="this.classList.toggle('collapsed')"` : "";

        tArea += `
            <div class="card ${cardClass}" ${onClick}>
                <div class="drug-name">${s.icon} ${s.title}</div>
                <div class="badge ${badgeClass}">${badgeText}</div>
                <div class="meds-container">
                    ${medsHTML}
                </div>
            </div>`;
    });
    
    document.getElementById('timelineArea').innerHTML = tArea;

    // 3. G√úNL√úK ƒ∞LERLEME BARI
    const dP = tMT > 0 ? Math.round((tKT/tMT)*100) : 0;
    document.getElementById('perf-pct').innerText = `%${dP} (${tKT}/${tMT})`;
    document.getElementById('perf-bar').style.width = dP + '%';
    
    if (dP === 100) {
        document.getElementById('perf-bar').style.backgroundColor = "var(--accent)";
        document.getElementById('perf-pct').style.color = "var(--accent)";
    } else {
        document.getElementById('perf-bar').style.backgroundColor = "var(--early)";
        document.getElementById('perf-pct').style.color = "var(--early)";
    }
}

// ƒ∞LK √áALI≈ûTIRMA VE D√ñNG√úLER
veriCek();
setInterval(veriCek, 30000); 
setInterval(saniyeTiktak, 1000); 
document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') veriCek(); });
</script>
</body>
</html>
